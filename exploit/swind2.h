#pragma once

#include "../global.h"
#include "../utils/TempFileGuard.h"

#define EQUALS(a, b)				(RtlCompareMemory(a, b, sizeof(b) - 1) == (sizeof(b) - 1))
#define NT_MACHINE					L"\\Registry\\Machine\\"
#define SVC_BASE					NT_MACHINE L"System\\CurrentControlSet\\Services\\"

#define STATUS_CI_OPTIONS_UNINITIALIZED ((NTSTATUS)0xC0000701L)
#define STATUS_CI_OPTIONS_ALREADYINITIALIZED ((NTSTATUS)0xC0000700L)

typedef struct
{
	bool has_value;
	ULONG original_value;
	PVOID address;
} CIOptionsState;

extern CIOptionsState InitialCiOptionsValue;

NTSTATUS DSEChangeState(BOOLEAN enable);
NTSTATUS ReadCIOptionsFromMemory(_Out_opt_ PULONG ciOptionsValue);
NTSTATUS AnalyzeCi(	_Out_ PVOID *CiOptionsAddress);
BOOLEAN IsCiEnabled();

std::unique_ptr<TempFileGuard> DropDriverFile(_In_ PWCHAR path);